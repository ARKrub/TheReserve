<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multi-Year Multi-Index Predictor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin:auto; }
input, button { margin: 5px 0; padding: 8px; }
#checkboxContainer { margin: 10px 0; }
#chartContainer { margin-top: 40px; }
</style>
</head>
<body>

<h1>Multi-Year Multi-Index Predictor</h1>

<label>Upload Excel file:</label>
<input type="file" id="fileInput" accept=".xlsx,.xls">

<div id="checkboxContainer"></div>

<h2>Prediction</h2>
<label>Enter Future Years to Predict (comma separated):</label>
<input type="text" id="yearsInput" placeholder="e.g. 2015,2016,2017">
<label>Polynomial Degree (1=linear, 2=quadratic, etc.):</label>
<input type="number" id="polyDegree" value="2" min="1">
<button id="predictBtn">Predict</button>
<button id="exportBtn">Export Predictions to Excel</button>

<p id="result"></p>

<div id="chartContainer">
  <canvas id="predictionChart" width="900" height="450"></canvas>
</div>

<script>
let data = {};
let columns = [];
let chart = null;
let lastPredictions = {};

document.getElementById('fileInput').addEventListener('change', handleFile);

function handleFile(e) {
  const file = e.target.files[0];
  if(!file) { alert("No file selected"); return; }

  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const workbook = XLSX.read(evt.target.result, {type:'binary'});
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(sheet, {defval:""});

      if(jsonData.length === 0) { alert("Excel sheet is empty"); return; }
      if(!jsonData[0].hasOwnProperty('Year')) { alert("Excel must have a 'Year' column"); return; }

      columns = Object.keys(jsonData[0]).filter(c => c !== 'Year');
      data = {};
      columns.forEach(col => data[col] = {});
      jsonData.forEach(row => {
        const year = parseInt(row['Year']);
        if(isNaN(year)) return;
        columns.forEach(col => {
          const val = parseFloat(row[col]);
          if(!isNaN(val)) data[col][year] = val;
        });
      });

      const container = document.getElementById('checkboxContainer');
      container.innerHTML = '<strong>Select index(es) to predict:</strong><br>';
      columns.forEach(col => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = col;
        checkbox.id = `chk_${col}`;
        container.appendChild(checkbox);
        const label = document.createElement('label');
        label.htmlFor = `chk_${col}`;
        label.innerText = col;
        container.appendChild(label);
        container.appendChild(document.createElement('br'));
      });

      alert("Data loaded successfully!");
    } catch(err) {
      alert("Error reading Excel: "+err);
    }
  };
  reader.readAsBinaryString(file);
}

document.getElementById('predictBtn').addEventListener('click', predict);
document.getElementById('exportBtn').addEventListener('click', exportExcel);

function predict() {
  try {
    const yearsInputRaw = document.getElementById('yearsInput').value;
    const yearsInput = yearsInputRaw.split(',').map(y=>parseInt(y.trim())).filter(y=>!isNaN(y));
    if(yearsInput.length === 0) { alert("Enter at least one valid year"); return; }

    const degree = parseInt(document.getElementById('polyDegree').value);
    const selectedCols = columns.filter(col => document.getElementById(`chk_${col}`).checked);
    if(selectedCols.length === 0) { alert("Select at least one index"); return; }

    let resultText = '';
    const datasets = [];
    lastPredictions = {};

    selectedCols.forEach(col => {
      const colData = data[col];
      const historicalYears = Object.keys(colData).map(y=>parseInt(y));
      const values = Object.values(colData).map(v=>parseFloat(v));

      const shiftedValues = values.map(v => v+1); // Base 1 indexing
      const trainingData = historicalYears.map((y,i)=>[y, shiftedValues[i]]);
      const regressionResult = regression.polynomial(trainingData, { order: degree });

      lastPredictions[col] = [];
      const allYears = [...historicalYears, ...yearsInput];
      const allPredictions = allYears.map(yv => {
        const pred = regressionResult.predict(yv)[1] - 1;
        if(yearsInput.includes(yv)) lastPredictions[col].push({year: yv, value: pred});
        return pred;
      });

      lastPredictions[col].forEach(p => {
        resultText += `${col}: Predicted index for year ${p.year} = ${p.value.toFixed(2)}<br>`;
      });

      const color = getRandomColor();
      datasets.push({
        label: col,
        data: allPredictions,
        borderColor: color,
        backgroundColor: color+'33',
        fill: false,
        tension: 0.2
      });
    });

    document.getElementById('result').innerHTML = resultText;

    if(chart) chart.destroy();
    const ctx = document.getElementById('predictionChart').getContext('2d');
    const labels = [...Object.keys(data[selectedCols[0]]).map(y=>y), ...yearsInput];
    chart = new Chart(ctx, {
      type:'line',
      data:{labels:labels,datasets:datasets},
      options:{
        responsive:true,
        plugins:{legend:{position:'top'},tooltip:{mode:'index',intersect:false}},
        scales:{x:{title:{display:true,text:'Year'}},y:{title:{display:true,text:'Index Value'}}}
      }
    });

  } catch(err) {
    alert("Error during prediction: "+err);
  }
}

function exportExcel() {
  if(Object.keys(lastPredictions).length === 0) { alert("Run prediction first"); return; }
  const exportData = [];
  for(const col in lastPredictions){
    lastPredictions[col].forEach(p=>{
      exportData.push({'Index':col,'Predicted Year':p.year,'Predicted Value':p.value});
    });
  }
  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Predictions");
  XLSX.writeFile(wb, "Predictions.xlsx");
}

function getRandomColor(){
  const r=Math.floor(Math.random()*200+20);
  const g=Math.floor(Math.random()*200+20);
  const b=Math.floor(Math.random()*200+20);
  return `rgb(${r},${g},${b})`;
}
</script>

</body>
</html>
